// Global initialization function (only called after user clicks ‚ÄúYes‚Äù)
function googleTranslateElementInit() {
    new google.translate.TranslateElement({
        pageLanguage: 'nl',
        includedLanguages: 'en',
        layout: google.translate.TranslateElement.InlineLayout.SIMPLE,
        autoDisplay: false
    }, 'google_translate_element');
}

// Global store for translations
let customTranslations = {};

// Local storage key for caching translations
const TRANSLATIONS_CACHE_KEY = 'bluedragon_translations';
const CACHE_EXPIRY_KEY = 'bluedragon_translations_expiry';
const CACHE_DURATION = 24 * 60 * 60 * 1000; // 24 hours

// Load translations from localStorage if available and valid
function loadTranslationsFromCache() {
    try {
        const cachedData = localStorage.getItem(TRANSLATIONS_CACHE_KEY);
        const cacheExpiry = localStorage.getItem(CACHE_EXPIRY_KEY);
        
        if (!cachedData || !cacheExpiry) {
            console.log("üìÇ No translation cache found");
            return null;
        }
        
        const expiryTime = parseInt(cacheExpiry);
        const timeLeft = expiryTime - Date.now();
        const hoursLeft = Math.round(timeLeft / (1000 * 60 * 60));
        
        if (Date.now() < expiryTime) {
            const translations = JSON.parse(cachedData);
            console.log("‚úÖ Loaded translations from cache");
            console.log(`‚è∞ Cache expires in ${hoursLeft} hours`);
            console.log("üìã Cached languages:", Object.keys(translations));
            return translations;
        } else {
            console.log("‚è∞ Translation cache expired, will fetch from Firebase");
            return null;
        }
    } catch (error) {
        console.log("‚ùå Failed to load from cache:", error);
        return null;
    }
}

// Save translations to localStorage
function saveTranslationsToCache(translations) {
    try {
        localStorage.setItem(TRANSLATIONS_CACHE_KEY, JSON.stringify(translations));
        localStorage.setItem(CACHE_EXPIRY_KEY, (Date.now() + CACHE_DURATION).toString());
        console.log("üíæ Translations saved to cache");
    } catch (error) {
        console.log("‚ùå Failed to save to cache:", error);
    }
}

// Clear translations cache (for debugging or forcing refresh)
function clearTranslationsCache() {
    try {
        localStorage.removeItem(TRANSLATIONS_CACHE_KEY);
        localStorage.removeItem(CACHE_EXPIRY_KEY);
        console.log("üóëÔ∏è Translation cache cleared");
    } catch (error) {
        console.log("‚ùå Failed to clear cache:", error);
    }
}

// Force refresh translations (can be called from console)
window.refreshTranslations = async function() {
    console.log("üîÑ ÊâãÂä®Âà∑Êñ∞ÁøªËØëÊï∞ÊçÆ...");
    clearTranslationsCache();
    await loadTranslationsFromFirebase(true);
    console.log("‚úÖ ÁøªËØëÊï∞ÊçÆÂ∑≤Âà∑Êñ∞");
};

// Load from Firebase
async function loadTranslationsFromFirebase(forceRefresh = false) {
    // Check if force refresh is requested or if debugging mode is active
    const isDebugging = window.location.search.includes('debug=1') || 
                       window.location.search.includes('refreshTranslations=1') ||
                       forceRefresh;
    
    if (isDebugging) {
        console.log("üîÑ Âº∫Âà∂Âà∑Êñ∞ÁøªËØëÊï∞ÊçÆ (Ë∞ÉËØïÊ®°ÂºèÊàñÊâãÂä®Âà∑Êñ∞)");
        clearTranslationsCache();
    }

    // First try to load from cache (unless force refresh)
    const cachedTranslations = isDebugging ? null : loadTranslationsFromCache();
    if (cachedTranslations) {
        window.customTranslations = cachedTranslations;
        console.log("üíø ‰ΩøÁî®ÁºìÂ≠òÁöÑÁøªËØëÊï∞ÊçÆ");
        applyCustomTranslations?.();
        return; // Use cached data, no need to fetch from Firebase
    }

    await waitForAppConfig();

    // Get restaurant name from AppConfig, use the same default as other files
    const rawRestName = window.AppConfig?.restName || 'asianboulevard';
    
    // Clean the restaurant name for Firebase path (remove spaces and special chars)
    const restName = rawRestName.replace(/\s+/g, '').replace(/[^a-zA-Z0-9]/g, '');
    
    console.log("üîç Raw restaurant name from AppConfig:", rawRestName);
    console.log("üîç Cleaned restaurant name for path:", restName);
    console.log("üîç window.AppConfig:", window.AppConfig);

    if (!restName) {
        console.error("‚ùå Cannot load translations: restName is missing.");
        return;
    }

    // Try multiple path structures to find translations
    const pathsToTry = [
        `${restName}/translations`,  // Standard path: RestaurantName/translations/
        `${restName}`,              // Direct path: RestaurantName/ (check for language keys)
        'translations'              // Root translations path
    ];

    let translationsData = null;
    let successfulPath = null;

    for (let translationsPath of pathsToTry) {
        try {
            console.log("üîÑ Trying translation path:", translationsPath);
            
            const ref = firebase.database().ref(translationsPath);
            const snapshot = await ref.once("value");
            const data = snapshot.val();

            if (data && typeof data === 'object' && Object.keys(data).length > 0) {
                // Check if this data has language keys (en, nl, etc.)
                const keys = Object.keys(data);
                const hasLanguageKeys = keys.some(key => ['en', 'nl', 'de', 'fr', 'es', 'zh', 'ja'].includes(key));
                
                if (hasLanguageKeys) {
                    translationsData = data;
                    successfulPath = translationsPath;
                    console.log("‚úÖ Found translations at path:", translationsPath);
                    console.log("üìã Available languages:", keys.filter(key => ['en', 'nl', 'de', 'fr', 'es', 'zh', 'ja'].includes(key)));
                    break;
                }
            }
        } catch (error) {
            console.log(`‚ùå Failed to load from path ${translationsPath}:`, error.message);
        }
    }

    window.customTranslations = translationsData || {};
    console.log("‚úÖ Final translations loaded from path:", successfulPath);
    console.log("üîç Available languages:", Object.keys(window.customTranslations));

    if (Object.keys(window.customTranslations).length === 0) {
        console.warn("‚ö†Ô∏è No translations found for restaurant:", rawRestName);
    } else {
        // Save to cache for future use
        saveTranslationsToCache(window.customTranslations);
    }

    applyCustomTranslations?.();
}

// Apply translations if available, fallback to Google
function applyCustomTranslations(allowGoogleFallback = true) {
    const language = document.documentElement.lang || 'nl';
    
    console.log(`üîç Current page language: ${language}`);
    console.log(`üîç Available custom translations:`, Object.keys(window.customTranslations || {}));

    // Check if we have translations for the requested language
    if (window.customTranslations && window.customTranslations[language]) {
        console.log(`‚úÖ Using custom translations for ${language} (with Google fallback: ${allowGoogleFallback})`);
        replaceTextInDocument(window.customTranslations[language], false, document.body, allowGoogleFallback);
        document.getElementById("google_translate_element").style.display = "none";
    } else {
        // If current language is 'nl' and we don't have 'nl' translations, 
        // this means the site is in its native Dutch language - no translation needed
        if (language === 'nl') {
            console.log("‚úÖ Site is in native Dutch language - no translation needed");
            document.getElementById("google_translate_element").style.display = "none";
            return;
        }
        
        // For other languages, try to apply any available translations
        const availableLanguages = Object.keys(window.customTranslations || {});
        if (availableLanguages.length > 0) {
            // If we have any translations available and the page is not in Dutch,
            // assume user wants translation and apply the first available language
            const targetLang = availableLanguages[0];
            console.log(`üîÑ No exact match for ${language}, applying ${targetLang} translations (with Google fallback: ${allowGoogleFallback})`);
            replaceTextInDocument(window.customTranslations[targetLang], false, document.body, allowGoogleFallback);
            document.getElementById("google_translate_element").style.display = "none";
        } else {
            console.warn(`No custom translations found for ${language}, ${allowGoogleFallback ? 'enabling' : 'not enabling'} Google Translate fallback.`);
            if (allowGoogleFallback) {
                // Initialize Google Translate if not already initialized
                initializeGoogleTranslateForFallback();
                document.getElementById("google_translate_element").style.display = "block";
            }
        }
        // ‚ùå Do NOT auto-init Google Translate here
    }
}

// DOM loaded: show popup if language differs
document.addEventListener("DOMContentLoaded", () => {
    // Check for debug/refresh parameters
    const urlParams = new URLSearchParams(window.location.search);
    const forceRefresh = urlParams.has('refreshTranslations') || urlParams.has('debug');
    
    if (forceRefresh) {
        console.log("üîß Ê£ÄÊµãÂà∞Ë∞ÉËØïÂèÇÊï∞ÔºåÂ∞ÜÂº∫Âà∂Âà∑Êñ∞ÁøªËØëÊï∞ÊçÆ");
    }

    const userLang = navigator.language || navigator.userLanguage;
    const pageLang = 'nl';
    const langCode = userLang.slice(0, 2);

    const languageNativeNames = {
        'en': 'English'
    };

    if (langCode !== pageLang) {
        document.getElementById("translate-popup").style.display = "flex";

        // ‚úÖ YES - initialize Translate only when user agrees
        document.getElementById("translate-yes").addEventListener("click", () => {
            document.getElementById("translate-popup").style.display = "none";
            document.getElementById("google_translate_element").style.display = "block";
            googleTranslateElementInit(); // ‚úÖ Initialize
            setTimeout(() => {
                applyTranslation(languageNativeNames[langCode]);
            }, 1000);
        });

        // ‚úÖ NO - completely remove all translate DOM
        document.getElementById("translate-no").addEventListener("click", () => {
            document.getElementById("translate-popup").style.display = "none";

            const iframe = document.querySelector("iframe.goog-te-banner-frame");
            if (iframe) iframe.remove();

            const container = document.getElementById("google_translate_element");
            if (container) container.innerHTML = "";
        });
    }

    loadTranslationsFromFirebase(forceRefresh);
    monitorLanguageChange();
    monitorDOMChanges(); // Add DOM change monitoring
});

function monitorLanguageChange() {
    const observer = new MutationObserver(applyCustomTranslations);
    observer.observe(document.documentElement, { attributes: true, attributeFilter: ["lang"] });
}

function monitorDOMChanges() {
    // Debounce function to avoid excessive calls
    let translationTimeout;
    
    const applyTranslationWithDelay = (targetNode = document.body) => {
        clearTimeout(translationTimeout);
        translationTimeout = setTimeout(() => {
            const currentLang = document.documentElement.lang || 'nl';
            if (currentLang !== 'nl' && window.customTranslations && window.customTranslations[currentLang]) {
                console.log("üåê DOMÁõëÂê¨Âô®Ëß¶ÂèëÁøªËØë...");
                if (typeof replaceTextInDocument === 'function') {
                    replaceTextInDocument(window.customTranslations[currentLang], false, targetNode, true);
                }
            }
        }, 100); // Êõ¥Áü≠ÁöÑÂª∂ËøüÁ°Æ‰øùÂèäÊó∂ÂìçÂ∫î
    };

    // Monitor for dynamically added elements (like food modals)
    const observer = new MutationObserver((mutations) => {
        let shouldTranslate = false;
        let targetNodes = new Set();

        mutations.forEach((mutation) => {
            if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
                mutation.addedNodes.forEach((node) => {
                    // Check if the added node is an element
                    if (node.nodeType === Node.ELEMENT_NODE) {
                        // ‚úÖ ÁâπÂà´Ê£ÄÊµãËèúÂìÅÂºπÁ™ó
                        const isFoodModal = (
                            node.id === 'messageBar-dynamic' ||
                            node.classList.contains('message-bar-dynamic')
                        );
                        
                        // ‚úÖ Ê£ÄÊµãÂÖ∂‰ªñÂèØÁøªËØëÂÜÖÂÆπ
                        const hasTranslatableContent = (
                            // ÊòéÁ°ÆÊ†áËÆ∞Ë¶ÅÁøªËØëÁöÑÂÖÉÁ¥†
                            node.hasAttribute && node.getAttribute('translate') === 'yes' ||
                            node.querySelector && node.querySelector('[translate="yes"]') ||
                            // ËèúÂìÅÂºπÁ™óÁõ∏ÂÖ≥ÂÜÖÂÆπ
                            isFoodModal ||
                            node.querySelector && (
                                node.querySelector('.item-description') ||
                                node.querySelector('.add-to-order') ||
                                node.querySelector('.allergy-info')
                            )
                        );
                        
                        if (hasTranslatableContent || isFoodModal) {
                            shouldTranslate = true;
                            targetNodes.add(node);
                            console.log("üîç DOMÁõëÂê¨Âô®Ê£ÄÊµãÂà∞Êñ∞ÁöÑÂèØÁøªËØëÂÜÖÂÆπ:", {
                                id: node.id || 'no-id',
                                class: node.className || 'no-class',
                                isFoodModal: isFoodModal,
                                hasTranslatableContent: hasTranslatableContent
                            });
                        }
                    }
                });
            }
        });

        if (shouldTranslate) {
            console.log(`üåê DOMÁõëÂê¨Âô®ÂáÜÂ§áÁøªËØë ${targetNodes.size} ‰∏™Êñ∞ÂÖÉÁ¥†`);
            // If we have specific target nodes, translate each one
            targetNodes.forEach(node => {
                console.log(`üåê ÂºÄÂßãÁøªËØëËäÇÁÇπ: ${node.id || node.className || 'unnamed'}`);
                applyTranslationWithDelay(node);
            });
        }
    });
    
    observer.observe(document.body, { 
        childList: true, 
        subtree: true 
    });

    // ‚úÖ È¢ùÂ§ñÁõëÂê¨ÊñáÊú¨ÂÜÖÂÆπÂèòÂåñÔºàÁî®‰∫éÈÄâÈ°πÊõ¥Êñ∞Á≠âÂú∫ÊôØÔºâ
    const textChangeObserver = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
            if (mutation.type === 'childList' || mutation.type === 'characterData') {
                const target = mutation.target;
                // Ê£ÄÊü•ÊòØÂê¶ÊòØËèúÂìÅÂºπÁ™ó‰∏≠ÁöÑÊñáÊú¨ÂèòÂåñ
                if (target.nodeType === Node.TEXT_NODE && target.parentElement) {
                    const modal = target.parentElement.closest('#messageBar-dynamic');
                    if (modal) {
                        console.log("üîç Ê£ÄÊµãÂà∞ËèúÂìÅÂºπÁ™óÂÜÖÊñáÊú¨ÂèòÂåñÔºåÂáÜÂ§áÁøªËØë");
                        setTimeout(() => applyTranslationWithDelay(modal), 50);
                    }
                }
            }
        });
    });
    
    textChangeObserver.observe(document.body, {
        childList: true,
        subtree: true,
        characterData: true
    });

    console.log("üîç DOM change monitoring activated - ÂÆûÊó∂ÁõëÂê¨Âä®ÊÄÅÂÜÖÂÆπ");
}

// Function to manually trigger translation for specific elements
function translateDynamicContent(targetElement = document.body, allowGoogleFallback = true) {
    const currentLang = document.documentElement.lang || 'nl';
    
    // Don't translate if page is in Dutch (original language)
    if (currentLang === 'nl') {
        return;
    }
    
    if (window.customTranslations && window.customTranslations[currentLang]) {
        console.log(`üåê Manually translating content to ${currentLang} (with Google fallback: ${allowGoogleFallback})...`);
        if (typeof replaceTextInDocument === 'function') {
            replaceTextInDocument(window.customTranslations[currentLang], false, targetElement, allowGoogleFallback);
        }
    } else {
        console.log(`‚ö†Ô∏è No custom translations available for ${currentLang}, trying Google Translate only...`);
        // If no custom translations but Google is available, try pure Google Translate
        if (allowGoogleFallback && window.google && window.google.translate) {
            triggerGoogleTranslateForElement(targetElement);
        }
    }
}

// Trigger Google Translate for an entire element (when no custom translations available)
function triggerGoogleTranslateForElement(targetElement) {
    console.log("üîÑ Â∞ùËØïÂØπÊï¥‰∏™ÂÖÉÁ¥†‰ΩøÁî®GoogleÁøªËØë...");
    
    // Mark element for Google Translate
    if (targetElement && targetElement.setAttribute) {
        targetElement.removeAttribute('translate');
        targetElement.classList.remove('notranslate');
        
        // Force Google Translate to re-process this element
        if (window.google && window.google.translate) {
            setTimeout(() => {
                try {
                    // Trigger Google Translate re-scan
                    const event = new Event('DOMNodeInserted', { bubbles: true });
                    targetElement.dispatchEvent(event);
                } catch (error) {
                    console.error("‚ùå GoogleÁøªËØëÂÖÉÁ¥†Â§ÑÁêÜÂ§±Ë¥•:", error);
                }
            }, 100);
        }
    }
}

// Make translateDynamicContent available globally
window.translateDynamicContent = translateDynamicContent;

// Function to clear translation cache (useful for development or updates)
function clearTranslationCache() {
    try {
        localStorage.removeItem(TRANSLATIONS_CACHE_KEY);
        localStorage.removeItem(CACHE_EXPIRY_KEY);
        console.log("üóëÔ∏è Translation cache cleared");
    } catch (error) {
        console.log("‚ùå Failed to clear cache:", error);
    }
}

// Make cache functions available globally for debugging
window.clearTranslationCache = clearTranslationCache;
window.loadTranslationsFromCache = loadTranslationsFromCache;

function applyCustomTranslationsMessageBar(selector = '.add-to-order', targetElement = document.body) {
    const language = document.documentElement.lang || 'nl';
    const targetElements = targetElement.querySelectorAll(selector);

    if (window.customTranslations && window.customTranslations[language]) {
        targetElements.forEach(el => {
            replaceTextInDocument(window.customTranslations[language], false, el);
        });
    }
}

function replaceTextInDocument(dictionary, revert = false, targetElement = document.body, allowGoogleFallback = true) {
    if (!dictionary || typeof dictionary !== 'object') return;

    const sortedDictionary = Object.entries(dictionary).sort(([a], [b]) => b.length - a.length);
    const currentLang = document.documentElement.lang || 'nl';
    
    // Collect untranslated text for Google Translate fallback
    const untranslatedElements = [];

    function translateText(text) {
        let translated = text;
        let changed = false;
        for (const [original, translatedStr] of sortedDictionary) {
            // Case-insensitive matching with case preservation
            const regex = new RegExp(revert ? translatedStr : original, "gi");
            if (regex.test(translated)) {
                const replacement = revert ? original : translatedStr;
                // Preserve original case (first letter capitalization)
                translated = translated.replace(regex, (match) => {
                    if (match.charAt(0) === match.charAt(0).toUpperCase()) {
                        return replacement.charAt(0).toUpperCase() + replacement.slice(1);
                    }
                    return replacement;
                });
                changed = true;
                console.log(`‚úÖ ÁøªËØëÊàêÂäü: '${text}' ‚Üí '${translated}'`);
            }
        }
        return { translated, changed };
    }

    function translateElement(element) {
        const walker = document.createTreeWalker(element, NodeFilter.SHOW_TEXT, null, false);
        let node;
        while ((node = walker.nextNode())) {
            const parent = node.parentElement;
            if (parent) {
                // ‚úÖ Á¨¨‰∏ÄÂéüÂàôÔºö‰∏•Ê†ºÈÅµÂÆà translate="no" Âíå notranslate Á±ª
                const hasNoTranslateAttribute = parent.getAttribute("translate") === "no";
                const hasNoTranslateClass = parent.classList.contains("notranslate");
                const hasYesTranslateAttribute = parent.getAttribute("translate") === "yes";
                
                // Â¶ÇÊûúÊòéÁ°ÆÊ†áËÆ∞‰∏çÁøªËØëÔºåÂàôË∑≥Ëøá
                if (hasNoTranslateAttribute || hasNoTranslateClass) {
                    continue;
                }
                
                // Âè™ÁøªËØëÊòéÁ°ÆÊ†áËÆ∞Ë¶ÅÁøªËØëÁöÑÔºåÊàñÊ≤°ÊúâÊ†áËÆ∞ÁöÑÂÖÉÁ¥†
                const shouldTranslate = hasYesTranslateAttribute || !parent.hasAttribute("translate");
                
                if (shouldTranslate) {
                    const originalText = node.nodeValue.trim();
                    
                    // Skip empty text or whitespace-only nodes
                    if (!originalText) continue;
                    
                    const { translated, changed } = translateText(originalText);
                    if (changed && originalText !== translated) {
                        node.nodeValue = translated;
                        // Ê†áËÆ∞‰∏∫Â∑≤ÁøªËØëÔºåÈò≤Ê≠¢ÈáçÂ§çÁøªËØë
                        parent.classList.add("notranslate");
                        console.log(`‚úÖ Ëá™ÂÆö‰πâÁøªËØëÊàêÂäü: '${originalText}' ‚Üí '${translated}'`);
                    } else if (allowGoogleFallback && !changed && currentLang !== 'nl' && originalText.length > 2) {
                        // Á¨¨‰∫åÂéüÂàôÔºöÊ≤°ÊúâËá™ÂÆö‰πâÁøªËØëÊó∂‰ΩøÁî®GoogleÁøªËØë
                        console.log(`‚ö†Ô∏è Êú™ÊâæÂà∞Ëá™ÂÆö‰πâÁøªËØë: '${originalText}' - Â∞Ü‰ΩøÁî®GoogleÁøªËØë`);
                        untranslatedElements.push({ element: parent, originalText });
                    }
                }
            }
        }
    }

    translateElement(targetElement);
    
    // Apply Google Translate to untranslated elements if any
    if (allowGoogleFallback && untranslatedElements.length > 0 && currentLang !== 'nl') {
        console.log(`üîÑ ÂèëÁé∞ ${untranslatedElements.length} ‰∏™Êú™ÁøªËØëÊñáÊú¨ÔºåÂ∞ùËØï‰ΩøÁî®GoogleÁøªËØë...`);
        applyGoogleTranslateToElements(untranslatedElements);
    }
}

// Apply Google Translate to specific elements that weren't found in custom dictionary
function applyGoogleTranslateToElements(untranslatedElements) {
    const currentLang = document.documentElement.lang || 'nl';
    
    // Only proceed if page language is not Dutch
    if (currentLang === 'nl') {
        console.log("‚ö†Ô∏è È°µÈù¢‰∏∫Ëç∑ÂÖ∞ËØ≠ÔºåÊó†ÈúÄGoogleÁøªËØë");
        return;
    }
    
    // ÂØπ‰∫éÂä®ÊÄÅÂÜÖÂÆπÔºå‰ºòÂÖà‰ΩøÁî®ÁÆÄÂåñÁöÑÁøªËØëÊñπÊ≥ï
    const isDynamicContent = untranslatedElements.some(item => 
        item.element.closest('#messageBar-dynamic') || 
        item.element.closest('.message-bar-dynamic')
    );
    
    if (isDynamicContent) {
        console.log("üçú Ê£ÄÊµãÂà∞Âä®ÊÄÅËèúÂìÅÈù¢ÊùøÔºå‰ΩøÁî®ÁÆÄÂåñÁøªËØëÁ≠ñÁï•");
        applySimplifiedTranslation(untranslatedElements);
        return;
    }

    // Check if Google Translate is available, if not, try to initialize
    if (!window.google || !window.google.translate) {
        console.log("üîÑ GoogleÁøªËØëÊú™ÂàùÂßãÂåñÔºåÊ≠£Âú®ÂàùÂßãÂåñ...");
        initializeGoogleTranslateForFallback();
        // Use simplified translation as fallback
        setTimeout(() => {
            applySimplifiedTranslation(untranslatedElements);
        }, 1000);
        return;
    }

    // Create a temporary container for Google Translate
    const tempContainer = document.createElement('div');
    tempContainer.style.position = 'absolute';
    tempContainer.style.left = '-9999px';
    tempContainer.style.visibility = 'hidden';
    tempContainer.setAttribute('class', 'temp-translate-container');
    document.body.appendChild(tempContainer);

    // Add untranslated text to temp container
    untranslatedElements.forEach((item, index) => {
        const tempElement = document.createElement('span');
        tempElement.textContent = item.originalText;
        tempElement.setAttribute('data-original-index', index);
        tempContainer.appendChild(tempElement);
    });

    // Try to trigger Google Translate on the temp container
    setTimeout(() => {
        try {
            // Check if Google Translate widget exists and is functional
            const googleTranslateElement = document.getElementById('google_translate_element');
            const googleTranslateCombo = document.querySelector('.goog-te-combo');
            const hasWorkingTranslate = googleTranslateElement && 
                                      (googleTranslateElement.querySelector('select') || googleTranslateCombo) &&
                                      window.google && 
                                      window.google.translate &&
                                      window.google.translate.TranslateElement;
            
            if (hasWorkingTranslate) {
                console.log("‚úÖ GoogleÁøªËØëÂ∞èÈÉ®‰ª∂ÂèØÁî®ÔºåÂºÄÂßãÁøªËØë...");
                // Force Google Translate to process the temp container
                const event = new Event('DOMContentLoaded', { bubbles: true });
                tempContainer.dispatchEvent(event);
                
                // Monitor for translation completion
                let checkCount = 0;
                const maxChecks = 20;
                
                const checkTranslation = () => {
                    checkCount++;
                    const tempElements = tempContainer.querySelectorAll('span[data-original-index]');
                    let translatedCount = 0;
                    
                    tempElements.forEach(tempElement => {
                        const translatedText = tempElement.textContent;
                        const originalIndex = parseInt(tempElement.getAttribute('data-original-index'));
                        const originalItem = untranslatedElements[originalIndex];
                        
                        if (translatedText && translatedText !== originalItem.originalText) {
                            // Translation successful, apply to original element
                            const textNode = findTextNodeInElement(originalItem.element, originalItem.originalText);
                            if (textNode) {
                                textNode.nodeValue = translatedText;
                                console.log(`‚úÖ GoogleÁøªËØëÊàêÂäü: '${originalItem.originalText}' ‚Üí '${translatedText}'`);
                                translatedCount++;
                            }
                        }
                    });
                    
                    if (translatedCount > 0 || checkCount >= maxChecks) {
                        // Clean up temp container
                        if (document.body.contains(tempContainer)) {
                            document.body.removeChild(tempContainer);
                        }
                        if (translatedCount > 0) {
                            console.log(`‚úÖ GoogleÁøªËØëÂÆåÊàê: ${translatedCount}/${untranslatedElements.length} ‰∏™ÊñáÊú¨Â∑≤ÁøªËØë`);
                        } else {
                            console.log("‚ö†Ô∏è GoogleÁøªËØëË∂ÖÊó∂ÔºåÈÉ®ÂàÜÊñáÊú¨ÂèØËÉΩÊú™ÁøªËØë");
                        }
                    } else {
                        // Continue checking
                        setTimeout(checkTranslation, 200);
                    }
                };
                
                setTimeout(checkTranslation, 500);
            } else {
                console.log("‚ö†Ô∏è GoogleÁøªËØëÂ∞èÈÉ®‰ª∂‰∏çÂèØÁî®ÔºåÊ≠£Âú®Â∞ùËØïÈáçÊñ∞ÂàùÂßãÂåñ...");
                initializeGoogleTranslateForFallback();
                if (document.body.contains(tempContainer)) {
                    document.body.removeChild(tempContainer);
                }
            }
        } catch (error) {
            console.error("‚ùå GoogleÁøªËØëÂõûÈÄÄÂ§±Ë¥•:", error);
            if (tempContainer.parentNode) {
                document.body.removeChild(tempContainer);
            }
        }
    }, 100);
}

// Helper function to find text node within element
function findTextNodeInElement(element, targetText) {
    const walker = document.createTreeWalker(
        element, 
        NodeFilter.SHOW_TEXT,
        null,
        false
    );
    
    let node;
    while ((node = walker.nextNode())) {
        if (node.nodeValue.trim() === targetText.trim()) {
            return node;
        }
    }
    return null;
}

// Initialize Google Translate specifically for fallback functionality
function initializeGoogleTranslateForFallback() {
    // Check if Google Translate is already initialized
    if (window.google && window.google.translate && window.google.translate.TranslateElement) {
        console.log("‚úÖ GoogleÁøªËØëÂ∑≤ÁªèÂàùÂßãÂåñ");
        return;
    }
    
    console.log("üîÑ ‰∏∫ÂõûÈÄÄÂäüËÉΩÂàùÂßãÂåñGoogleÁøªËØë...");
    
    const googleTranslateElement = document.getElementById("google_translate_element");
    if (!googleTranslateElement) {
        console.warn("‚ö†Ô∏è GoogleÁøªËØëÂÖÉÁ¥†Êú™ÊâæÂà∞");
        return;
    }
    
    // Try to initialize Google Translate
    try {
        // First, make sure the script is loaded
        if (typeof google === 'undefined' || !google.translate) {
            console.log("üì• GoogleÁøªËØëËÑöÊú¨Â∞öÊú™Âä†ËΩΩÔºåÁ≠âÂæÖÂä†ËΩΩ...");
            
            // Wait for script to load and retry
            let retryCount = 0;
            const maxRetries = 10;
            
            const waitForScript = () => {
                retryCount++;
                if (typeof google !== 'undefined' && google.translate) {
                    console.log("‚úÖ GoogleÁøªËØëËÑöÊú¨Â∑≤Âä†ËΩΩ");
                    performInitialization();
                } else if (retryCount < maxRetries) {
                    console.log(`‚è≥ Á≠âÂæÖGoogleÁøªËØëËÑöÊú¨Âä†ËΩΩ... (${retryCount}/${maxRetries})`);
                    setTimeout(waitForScript, 500);
                } else {
                    console.error("‚ùå GoogleÁøªËØëËÑöÊú¨Âä†ËΩΩË∂ÖÊó∂");
                }
            };
            
            waitForScript();
        } else {
            performInitialization();
        }
        
    } catch (error) {
        console.error("‚ùå GoogleÁøªËØëÂàùÂßãÂåñÂ§±Ë¥•:", error);
    }
    
    function performInitialization() {
        try {
            // Show translate element temporarily for initialization
            const originalDisplay = googleTranslateElement.style.display;
            googleTranslateElement.style.display = "block";
            
            // Initialize Google Translate with a simple configuration
            new google.translate.TranslateElement({
                pageLanguage: 'nl',
                includedLanguages: 'en',
                layout: google.translate.TranslateElement.InlineLayout.SIMPLE,
                autoDisplay: false
            }, 'google_translate_element');
            
            console.log("‚úÖ GoogleÁøªËØëÊàêÂäüÂàùÂßãÂåñ");
            
            // Hide it again after initialization
            setTimeout(() => {
                googleTranslateElement.style.display = originalDisplay || "none";
                console.log("üîß GoogleÁøªËØëÂ∑≤ÈöêËóè‰ΩÜ‰øùÊåÅÂäüËÉΩ");
            }, 2000);
            
        } catch (initError) {
            console.error("‚ùå GoogleÁøªËØëÂÆûÈôÖÂàùÂßãÂåñÂ§±Ë¥•:", initError);
        }
    }
}

// Auto click Google Translate language
function applyTranslation(languageNativeName) {
    const spanElements = document.querySelectorAll('span');
    const selectLang = Array.from(spanElements).find(span => span.textContent.trim() === "Select Language");

    if (selectLang) {
        selectLang.click();
        setTimeout(() => {
            const observer = new MutationObserver((_, obs) => {
                const updated = document.querySelectorAll('.VIpgJd-ZVi9od-xl07Ob-lTBxed a span');
                const target = Array.from(updated).find(span => span.textContent.includes(languageNativeName));
                if (target) {
                    target.click();
                    document.getElementById("google_translate_element").style.display = "none";
                    
                    // Force apply custom translations after a delay
                    setTimeout(() => {
                        console.log("üîÑ Forcing custom translation application...");
                        if (window.customTranslations && Object.keys(window.customTranslations).length > 0) {
                            const targetLang = Object.keys(window.customTranslations)[0];
                            console.log(`üéØ Force applying ${targetLang} translations`);
                            replaceTextInDocument(window.customTranslations[targetLang], false);
                        }
                    }, 500);
                    
                    obs.disconnect();
                }
            });
            observer.observe(document.body, { childList: true, subtree: true });
        }, 1000);
    }
}

// Simplified translation strategy for dynamic content (more reliable than Google Translate widget)
function applySimplifiedTranslation(untranslatedElements) {
    console.log(`üîß ‰ΩøÁî®ÁÆÄÂåñÁøªËØëÁ≠ñÁï•Â§ÑÁêÜ ${untranslatedElements.length} ‰∏™Êú™ÁøªËØëÊñáÊú¨`);
    
    // Basic Dutch to English translation dictionary for common food terms
    const basicTranslations = {
        // Common food terms
        'salade': 'salad',
        'soep': 'soup',
        'vlees': 'meat',
        'vis': 'fish',
        'kip': 'chicken',
        'rundvlees': 'beef',
        'varkensvlees': 'pork',
        'groenten': 'vegetables',
        'rijst': 'rice',
        'noedels': 'noodles',
        'tofu': 'tofu',
        'garnalen': 'shrimp',
        'eend': 'duck',
        'lam': 'lamb',
        
        // Price and quantity terms
        'prijs': 'price',
        'totaal': 'total',
        'subtotaal': 'subtotal',
        'btw': 'vat',
        'per stuk': 'per piece',
        'per portie': 'per serving',
        
        // Common interface terms
        'toevoegen': 'add',
        'verwijderen': 'remove',
        'bestellen': 'order',
        'betalen': 'pay',
        'annuleren': 'cancel',
        'bevestigen': 'confirm',
        'wijzigen': 'modify',
        'terug': 'back',
        'volgende': 'next',
        'vorige': 'previous',
        'sluiten': 'close',
        'openen': 'open',
        
        // Descriptive terms
        'vers': 'fresh',
        'warm': 'warm',
        'koud': 'cold',
        'pittig': 'spicy',
        'zoet': 'sweet',
        'zuur': 'sour',
        'zout': 'salty',
        'krokant': 'crispy',
        'zacht': 'soft',
        'mals': 'tender',
        'sappig': 'juicy',
        'gemarineerd': 'marinated',
        'gebakken': 'fried',
        'gegrild': 'grilled',
        'gestoomd': 'steamed',
        
        // Time and service terms
        'bereidingstijd': 'preparation time',
        'wachttijd': 'waiting time',
        'minuten': 'minutes',
        'uur': 'hour',
        'dag': 'day',
        'week': 'week',
        'maand': 'month',
        
        // Common phrases
        'niet beschikbaar': 'not available',
        'uitverkocht': 'sold out',
        'nieuw': 'new',
        'populair': 'popular',
        'aanbevolen': 'recommended',
        'speciaal': 'special',
        'seizoen': 'season',
        'dagelijks': 'daily',
        
        // Additional common terms
        'inclusief': 'including',
        'exclusief': 'excluding',
        'extra': 'extra',
        'gratis': 'free',
        'optioneel': 'optional',
        'verplicht': 'required'
    };
    
    let translatedCount = 0;
    
    untranslatedElements.forEach(item => {
        const originalText = item.originalText.toLowerCase().trim();
        let translatedText = null;
        
        // Direct match
        if (basicTranslations[originalText]) {
            translatedText = basicTranslations[originalText];
        } else {
            // Try to find partial matches for compound terms
            for (const [dutch, english] of Object.entries(basicTranslations)) {
                if (originalText.includes(dutch)) {
                    translatedText = originalText.replace(new RegExp(dutch, 'gi'), english);
                    break;
                }
            }
        }
        
        if (translatedText) {
            // Preserve original capitalization
            if (item.originalText[0] === item.originalText[0].toUpperCase()) {
                translatedText = translatedText.charAt(0).toUpperCase() + translatedText.slice(1);
            }
            
            // Apply translation to the text node
            const textNode = findTextNodeInElement(item.element, item.originalText);
            if (textNode) {
                textNode.nodeValue = translatedText;
                console.log(`‚úÖ ÁÆÄÂåñÁøªËØëÊàêÂäü: '${item.originalText}' ‚Üí '${translatedText}'`);
                translatedCount++;
            }
        } else {
            console.log(`‚ö†Ô∏è Êú™ÊâæÂà∞ÁøªËØë: '${item.originalText}'`);
        }
    });
    
    if (translatedCount > 0) {
        console.log(`‚úÖ ÁÆÄÂåñÁøªËØëÂÆåÊàê: ${translatedCount}/${untranslatedElements.length} ‰∏™ÊñáÊú¨Â∑≤ÁøªËØë`);
    } else {
        console.log("‚ö†Ô∏è ÁÆÄÂåñÁøªËØëÊú™ÊâæÂà∞ÂåπÈÖçÈ°π");
    }
}
